<nz-card [nzTitle]="cardTitle" [nzExtra]="cardExtra">
  <ng-template #cardTitle>
    <span style="font-size: 18px; font-weight: 500;">財務概覽</span>
    <span style="color: #999; font-size: 14px; margin-left: 12px;">請款與付款統計</span>
  </ng-template>
  <ng-template #cardExtra>
    <button nz-button (click)="refresh()">
      <span nz-icon nzType="reload"></span>
      重新整理
    </button>
  </ng-template>

  @if (loading()) {
    <div style="display: block; padding: 48px; text-align: center;">
      <nz-spin nzSimple></nz-spin>
    </div>
  } @else {
    <div nz-row [nzGutter]="16">
      <!-- 應收帳款 -->
      <div nz-col [nzXs]="24" [nzSm]="12" [nzLg]="8">
        <nz-card nzTitle="應收帳款" [nzExtra]="receivableLinkTpl" [nzHoverable]="true" nzSize="small">
          <nz-statistic
            [nzValue]="summary().receivables.total"
            nzTitle="總應收金額"
            [nzPrefix]="dollarTpl"
            [nzValueStyle]="{ color: '#3f8600' }">
          </nz-statistic>

          <nz-divider></nz-divider>

          <nz-progress
            [nzPercent]="summary().receivables.collectionRate"
            [nzFormat]="formatPercent"
            nzStatus="active">
          </nz-progress>

          <div style="display: flex; justify-content: space-between; margin-top: 12px; color: #666;">
            <span>已收：${{ formatNumber(summary().receivables.collected) }}</span>
            <span>待收：${{ formatNumber(summary().receivables.pending) }}</span>
          </div>
        </nz-card>
      </div>

      <!-- 應付帳款 -->
      <div nz-col [nzXs]="24" [nzSm]="12" [nzLg]="8">
        <nz-card nzTitle="應付帳款" [nzExtra]="payableLinkTpl" [nzHoverable]="true" nzSize="small">
          <nz-statistic
            [nzValue]="summary().payables.total"
            nzTitle="總應付金額"
            [nzPrefix]="dollarTpl"
            [nzValueStyle]="{ color: '#cf1322' }">
          </nz-statistic>

          <nz-divider></nz-divider>

          <nz-progress
            [nzPercent]="summary().payables.paymentRate"
            [nzFormat]="formatPercent"
            nzStatus="active"
            nzStrokeColor="#cf1322">
          </nz-progress>

          <div style="display: flex; justify-content: space-between; margin-top: 12px; color: #666;">
            <span>已付：${{ formatNumber(summary().payables.paid) }}</span>
            <span>待付：${{ formatNumber(summary().payables.pending) }}</span>
          </div>
        </nz-card>
      </div>

      <!-- 毛利概覽 -->
      <div nz-col [nzXs]="24" [nzSm]="24" [nzLg]="8">
        <nz-card nzTitle="損益概覽" [nzHoverable]="true" nzSize="small">
          <nz-statistic
            [nzValue]="summary().grossProfit"
            nzTitle="毛利"
            [nzPrefix]="dollarTpl"
            [nzValueStyle]="getProfitStyle()">
          </nz-statistic>

          <nz-divider></nz-divider>

          <div style="text-align: center;">
            @if (summary().grossProfitMargin >= 20) {
              <nz-tag nzColor="success">毛利率：{{ summary().grossProfitMargin.toFixed(1) }}%</nz-tag>
            } @else if (summary().grossProfitMargin >= 10) {
              <nz-tag nzColor="warning">毛利率：{{ summary().grossProfitMargin.toFixed(1) }}%</nz-tag>
            } @else {
              <nz-tag nzColor="error">毛利率：{{ summary().grossProfitMargin.toFixed(1) }}%</nz-tag>
            }
          </div>

          <div style="margin-top: 16px; color: #666; font-size: 12px; text-align: center;">
            統計時間：{{ summary().asOf | date: 'yyyy-MM-dd HH:mm' }}
          </div>
        </nz-card>
      </div>
    </div>

    <!-- 快速操作 -->
    <nz-card nzTitle="快速操作" style="margin-top: 16px;" nzSize="small">
      <div nz-row [nzGutter]="16">
        <div nz-col [nzSpan]="6">
          <button nz-button nzType="primary" nzBlock (click)="goToInvoices()">
            <span nz-icon nzType="file-text"></span>
            請款單管理
          </button>
        </div>
        <div nz-col [nzSpan]="6">
          <button nz-button nzType="default" nzBlock (click)="goToPayments()">
            <span nz-icon nzType="wallet"></span>
            付款單管理
          </button>
        </div>
        <div nz-col [nzSpan]="6">
          <button nz-button nzType="dashed" nzBlock (click)="createInvoice()">
            <span nz-icon nzType="plus"></span>
            新增請款單
          </button>
        </div>
        <div nz-col [nzSpan]="6">
          <button nz-button nzType="dashed" nzBlock (click)="createPayment()">
            <span nz-icon nzType="plus"></span>
            新增付款單
          </button>
        </div>
      </div>
    </nz-card>
  }
</nz-card>

<!-- 連結模板 -->
<ng-template #receivableLinkTpl>
  <a (click)="goToInvoices()">查看全部</a>
</ng-template>

<ng-template #payableLinkTpl>
  <a (click)="goToPayments()">查看全部</a>
</ng-template>

<ng-template #dollarTpl>$</ng-template>
