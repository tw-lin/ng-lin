# åˆç´„æ¨¡çµ„è¨­è¨ˆæ¦‚è¦½ (Contract Module Design Overview)

> **ç‰ˆæœ¬**: v1.0.0  
> **æœ€å¾Œæ›´æ–°**: 2025-12-22  
> **ç¶­è­·è€…**: GigHub é–‹ç™¼åœ˜éšŠ

## ç›®éŒ„

1. [æ ¸å¿ƒè¨­è¨ˆæ¦‚å¿µ](#æ ¸å¿ƒè¨­è¨ˆæ¦‚å¿µ)
2. [æ¨¡çµ„æ¶æ§‹](#æ¨¡çµ„æ¶æ§‹)
3. [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
4. [æŠ€è¡“æ£§èˆ‡å¯¦ä½œ](#æŠ€è¡“æ£§èˆ‡å¯¦ä½œ)
5. [è³‡æ–™æ¨¡å‹](#è³‡æ–™æ¨¡å‹)
6. [å®‰å…¨èˆ‡æ¬Šé™](#å®‰å…¨èˆ‡æ¬Šé™)
7. [AI èˆ‡æ–‡ä»¶è§£ææ•´åˆ](#ai-èˆ‡æ–‡ä»¶è§£ææ•´åˆ)
8. [ç‹€æ…‹ç®¡ç†èˆ‡äº‹ä»¶](#ç‹€æ…‹ç®¡ç†èˆ‡äº‹ä»¶)
9. [ä½¿ç”¨è€…ä»‹é¢æµç¨‹](#ä½¿ç”¨è€…ä»‹é¢æµç¨‹)
10. [æ“´å±•æ€§èˆ‡ç¶­è­·](#æ“´å±•æ€§èˆ‡ç¶­è­·)

---

## æ ¸å¿ƒè¨­è¨ˆæ¦‚å¿µ

### åˆç´„æ ¸å¿ƒå¯¦é«” (Domain Core / Contract Core)

åˆç´„æ¨¡çµ„çš„æ ¸å¿ƒå¯¦é«”ï¼ŒåŒ…å«åˆç´„çš„æ¥­å‹™é‚è¼¯ã€ç‹€æ…‹ç®¡ç†åŠé—œéµæ¬„ä½ã€‚åˆç´„æ˜¯æ–½å·¥å°ˆæ¡ˆä¸­çš„æ ¸å¿ƒæ–‡ä»¶ï¼Œè¨˜éŒ„å¥‘ç´„é—œä¿‚ã€è²¬ä»»ç¯„åœã€é‡‘é¡æ¢æ¬¾åŠå±¥ç´„æ¢ä»¶ã€‚

### è¨­è¨ˆåŸå‰‡

#### 1. **å–®ä¸€è³‡æ–™ä¾†æº (Single Source of Truth)**
- åˆç´„è³‡æ–™çµ±ä¸€ç®¡ç†æ–¼ Firestore
- æ‰€æœ‰åˆç´„æ“ä½œå¿…é ˆé€é Repository å±¤
- é¿å…è³‡æ–™æ•£ä½ˆæˆ–é‡è¤‡

#### 2. **æ¥­å‹™é‚è¼¯é›†ä¸­**
- é©—è­‰è¦å‰‡é›†ä¸­æ–¼ Service/Facade å±¤
- ç‹€æ…‹è®Šæ›´é‚è¼¯çµ±ä¸€ç®¡ç†
- æ¬Šé™æ§åˆ¶èˆ‡æˆæ¬Šæª¢æŸ¥é›†ä¸­è™•ç†

#### 3. **è§£è€¦ UI èˆ‡æ¥­å‹™é‚è¼¯**
- UI å…ƒä»¶åƒ…è² è²¬å±•ç¤ºèˆ‡ä½¿ç”¨è€…äº’å‹•
- æ ¸å¿ƒæ¨¡å‹è™•ç†æ¥­å‹™é‚è¼¯èˆ‡è³‡æ–™è½‰æ›
- é€é Signals é€²è¡ŒéŸ¿æ‡‰å¼ç‹€æ…‹ç®¡ç†

#### 4. **æ¨¡çµ„åŒ–èˆ‡å¯æ“´å±•æ€§**
- éµå¾ª Angular 20 Standalone æ¶æ§‹
- åŠŸèƒ½æ¨¡çµ„åŒ–ï¼Œæ˜“æ–¼æ“´å±•æ–°åŠŸèƒ½
- ä¿æŒæ¸…æ™°çš„æ¨¡çµ„é‚Šç•Œèˆ‡å…¬é–‹ API

---

## æ¨¡çµ„æ¶æ§‹

### ä¸‰å±¤æ¶æ§‹ (Three-Layer Architecture)

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Presentation Layer (UI)                 â”‚
â”‚  contract-list, contract-detail, contract-edit,         â”‚
â”‚  contract-wizard, contract-upload                        â”‚
â”‚  - å±•ç¤ºé‚è¼¯ (Display Logic)                              â”‚
â”‚  - ä½¿ç”¨è€…äº’å‹• (User Interaction)                         â”‚
â”‚  - Signals for state (signal(), computed())              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“ inject()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Business Layer (Service/Facade)            â”‚
â”‚  ContractFacade, ContractService                         â”‚
â”‚  - æ¥­å‹™é‚è¼¯å”èª¿ (Business Logic Coordination)            â”‚
â”‚  - ç‹€æ…‹ç®¡ç† (State Management with Signals)             â”‚
â”‚  - äº‹ä»¶ç™¼å¸ƒè¨‚é–± (BlueprintEventBus)                      â”‚
â”‚  - æ¬Šé™é©—è­‰ (Permission Checks)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“ inject()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Data Layer (Repository)                 â”‚
â”‚  ContractRepository                                      â”‚
â”‚  - è³‡æ–™å­˜å–æŠ½è±¡ (Data Access Abstraction)                â”‚
â”‚  - Firestore æ“ä½œå°è£                                     â”‚
â”‚  - CRUD æ“ä½œ (Create, Read, Update, Delete)             â”‚
â”‚  - æ¬„ä½è½‰æ› (snake_case â†” camelCase)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Firebase/Firestore + Storage                â”‚
â”‚  - Database (Firestore)                                  â”‚
â”‚  - File Storage (Cloud Storage)                          â”‚
â”‚  - Security Rules                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

### ç›®éŒ„çµæ§‹

\`\`\`
contract/
â”œâ”€ design.md                          # æœ¬æ–‡ä»¶
â”œâ”€ README.md                          # æ¨¡çµ„ä½¿ç”¨èªªæ˜
â”œâ”€ routes.ts                          # è·¯ç”±é…ç½®
â”œâ”€ index.ts                           # å…¬é–‹ API
â”œâ”€ contract-shell.component.ts        # Shell å”èª¿å±¤
â”‚
â”œâ”€ components/                        # UI å…ƒä»¶
â”‚   â”œâ”€ contract-list.component.ts     # åˆç´„åˆ—è¡¨é 
â”‚   â”œâ”€ contract-detail.component.ts   # åˆç´„è©³æƒ…é 
â”‚   â”œâ”€ contract-edit.component.ts     # åˆç´„ç·¨è¼¯é 
â”‚   â”œâ”€ contract-wizard.component.ts   # åˆç´„å»ºç«‹ç²¾éˆ
â”‚   â””â”€ contract-upload.component.ts   # åˆç´„ä¸Šå‚³å…ƒä»¶
â”‚
â”œâ”€ ui/                                # å±•ç¤ºå‹å…ƒä»¶
â”‚   â”œâ”€ contract-card.component.ts
â”‚   â”œâ”€ contract-status-badge.component.ts
â”‚   â””â”€ contract-timeline.component.ts
â”‚
â”œâ”€ services/                          # æ¥­å‹™é‚è¼¯å±¤
â”‚   â”œâ”€ contract.facade.ts             # Facade Pattern (ä¸»è¦ API)
â”‚   â””â”€ contract.service.ts            # æ¥­å‹™é‚è¼¯æœå‹™
â”‚
â”œâ”€ data-access/                       # è³‡æ–™å­˜å–å±¤
â”‚   â”œâ”€ repositories/
â”‚   â”‚   â””â”€ contract.repository.ts     # Firestore Repository
â”‚   â””â”€ models/
â”‚       â””â”€ contract.model.ts          # Domain Model
â”‚
â”œâ”€ state/                             # ç‹€æ…‹ç®¡ç†
â”‚   â””â”€ contract.store.ts              # Signals Store (å¯é¸)
â”‚
â””â”€ shared/                            # æ¨¡çµ„å…§å…±ç”¨
    â””â”€ types/
        â””â”€ contract.types.ts          # é¡å‹å®šç¾©
\`\`\`

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. åˆç´„ç®¡ç† (Contract Management)

#### 1.1 åˆç´„ CRUD æ“ä½œ
- **æ–°å¢åˆç´„**: é€éç²¾éˆæˆ–å¿«é€Ÿå»ºç«‹è¡¨å–®
- **ç·¨è¼¯åˆç´„**: æ›´æ–°åˆç´„è³‡è¨Šã€æ¢æ¬¾ã€é‡‘é¡
- **åˆªé™¤åˆç´„**: è»Ÿåˆªé™¤ï¼ˆè¨­å®š \`deletedAt\` æ¬„ä½ï¼‰
- **æŸ¥è©¢åˆç´„**: ä¾ Blueprintã€ç‹€æ…‹ã€é¡å‹ã€æ—¥æœŸç¯„åœç¯©é¸

#### 1.2 åˆç´„ç‹€æ…‹ç®¡ç†
åˆç´„ç”Ÿå‘½é€±æœŸç‹€æ…‹æµè½‰ï¼š

\`\`\`
è‰ç¨¿ (Draft)
    â†“
å¯©æ ¸ä¸­ (Under Review)
    â†“
ç”Ÿæ•ˆä¸­ (Active)
    â†“
å·²å®Œæˆ (Completed) / å·²çµ‚æ­¢ (Terminated)
\`\`\`

**ç‹€æ…‹å®šç¾©**:
- \`draft\`: è‰ç¨¿ï¼Œå°šæœªæäº¤å¯©æ ¸
- \`under_review\`: å¯©æ ¸ä¸­ï¼Œç­‰å¾…æ ¸å‡†
- \`active\`: ç”Ÿæ•ˆä¸­ï¼Œæ­£åœ¨å±¥ç´„
- \`completed\`: å·²å®Œæˆï¼Œåˆç´„å±¥è¡Œå®Œç•¢
- \`terminated\`: å·²çµ‚æ­¢ï¼Œåˆç´„æå‰çµ‚æ­¢
- \`suspended\`: æš«åœï¼Œè‡¨æ™‚ä¸­æ­¢å±¥ç´„

#### 1.3 åˆç´„ç‰ˆæœ¬æ§åˆ¶
- æ¯æ¬¡ä¿®æ”¹ç”Ÿæˆæ–°ç‰ˆæœ¬è¨˜éŒ„
- ä¿ç•™æ­·å²ç‰ˆæœ¬ä¾›æŸ¥è©¢
- ç‰ˆæœ¬å·®ç•°æ¯”è¼ƒåŠŸèƒ½
- å¯©æ ¸è¨˜éŒ„èˆ‡è®Šæ›´è¿½è¹¤

### 2. é™„ä»¶èˆ‡æ–‡ä»¶ç®¡ç† (Attachment & Document Management)

#### 2.1 æ–‡ä»¶ä¸Šå‚³
- **æ”¯æ´æ ¼å¼**: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG
- **æª”æ¡ˆå¤§å°é™åˆ¶**: å–®æª”æœ€å¤§ 10MB
- **è·¯å¾‘ç®¡ç†**: \`contracts/{blueprintId}/{contractId}/attachments/{fileId}\`

#### 2.2 æ–‡ä»¶æ“ä½œ
- **ä¸Šå‚³**: é€é Cloud Storage API
- **é è¦½**: å…§å»º PDF/åœ–ç‰‡é è¦½å™¨
- **ä¸‹è¼‰**: ç”¢ç”Ÿè‡¨æ™‚ä¸‹è¼‰é€£çµ
- **åˆªé™¤**: è»Ÿåˆªé™¤æˆ–ç¡¬åˆªé™¤

#### 2.3 OCR èˆ‡ AI è§£æ
- è‡ªå‹•è§£æ PDF åˆç´„å…§å®¹
- æå–é—œéµæ¬„ä½ï¼ˆå¥‘ç´„æ–¹ã€é‡‘é¡ã€æ—¥æœŸã€æ¢æ¬¾ï¼‰
- ç”¢ç”Ÿå·¥é …æ¸…å–®
- äººå·¥æ ¡æ­£èˆ‡ç¢ºèªæ©Ÿåˆ¶

### 3. æ¬Šé™æ§åˆ¶ (Permission Control)

#### 3.1 è§’è‰²å®šç¾©
| è§’è‰² | æ¬Šé™ |
|-----|------|
| **Owner** | å®Œæ•´æ¬Šé™ï¼ˆCRUDã€å¯©æ ¸ã€æˆæ¬Šï¼‰ |
| **Admin** | ç®¡ç†æ¬Šé™ï¼ˆCRUDã€å¯©æ ¸ï¼‰ |
| **Member** | åŸºæœ¬æ¬Šé™ï¼ˆè®€å–ã€å»ºç«‹ã€ç·¨è¼¯è‡ªå·±çš„åˆç´„ï¼‰ |
| **Viewer** | å”¯è®€æ¬Šé™ |

#### 3.2 æ¬Šé™æª¢æŸ¥å±¤ç´š
1. **UI å±¤**: æŒ‰éˆ•/æ“ä½œé¡¯ç¤ºæ§åˆ¶
2. **Guard å±¤**: è·¯ç”±å®ˆè¡›
3. **Service å±¤**: æ¥­å‹™é‚è¼¯é©—è­‰
4. **Security Rules**: Firestore æœ€çµ‚é˜²ç·š

### 4. å·¥ä½œæµèˆ‡å¯©æ‰¹ (Workflow & Approval)

#### 4.1 å¯©æ‰¹æµç¨‹
\`\`\`
æäº¤å¯©æ ¸ â†’ ä¸€ç´šå¯©æ ¸ â†’ äºŒç´šå¯©æ ¸ â†’ æ ¸å‡†/é§å›
\`\`\`

#### 4.2 é€šçŸ¥æ©Ÿåˆ¶
- **ç‹€æ…‹è®Šæ›´**: è‡ªå‹•é€šçŸ¥ç›¸é—œäººå“¡
- **å¯©æ‰¹æé†’**: å¾…å¯©é …ç›®æé†’
- **åˆ°æœŸæé†’**: åˆç´„åˆ°æœŸå‰ 30/15/7 å¤©æé†’
- **é€¾æœŸè­¦å‘Š**: åˆç´„é€¾æœŸè‡ªå‹•è­¦å‘Š

### 5. çµ±è¨ˆèˆ‡å ±è¡¨ (Statistics & Reports)

- åˆç´„ç¸½æ•¸èˆ‡ç‹€æ…‹åˆ†å¸ƒ
- åˆç´„é‡‘é¡çµ±è¨ˆï¼ˆç¸½é¡ã€å·²ä»˜ã€å¾…ä»˜ï¼‰
- åˆç´„å±¥ç´„ç‡çµ±è¨ˆ
- åˆ°æœŸåˆç´„é è­¦æ¸…å–®
- å¯©æ‰¹æ•ˆç‡å ±è¡¨

---

## æŠ€è¡“æ£§èˆ‡å¯¦ä½œ

### å‰ç«¯æ¡†æ¶
- **Angular 20.3.x**: ä¸»æ¡†æ¶
- **ng-alain 20.1.x**: ä¼æ¥­ç´š UI æ¡†æ¶
- **ng-zorro-antd 20.3.x**: UI å…ƒä»¶åº«
- **TypeScript 5.9.x**: é¡å‹ç³»çµ±
- **RxJS 7.8.x**: éŸ¿æ‡‰å¼ç¨‹å¼è¨­è¨ˆ

### Firebase æ•´åˆ
- **@angular/fire 20.0.1**: Firebase Angular SDK

#### Firebase æœå‹™
| æœå‹™ | ç”¨é€” |
|-----|------|
| **Authentication** | ä½¿ç”¨è€…èªè­‰èˆ‡æˆæ¬Š |
| **Firestore** | åˆç´„è³‡æ–™å­˜å– |
| **Cloud Storage** | é™„ä»¶èˆ‡æ–‡ä»¶ç®¡ç† |
| **Cloud Functions** | AI è§£æã€é€šçŸ¥ã€æ‰¹æ¬¡è™•ç† |
| **Security Rules** | è³‡æ–™å­˜å–æ¬Šé™æ§åˆ¶ |

### è³‡æ–™å­˜å–æ¨¡å¼
- **Repository Pattern**: çµ±ä¸€è³‡æ–™å­˜å–ä»‹é¢
- **FirestoreBaseRepository**: ç¹¼æ‰¿åŸºç¤ Repository
- **executeWithRetry**: è‡ªå‹•é‡è©¦æ©Ÿåˆ¶ï¼ˆè™•ç†æš«æ™‚æ€§å¤±æ•—ï¼‰

### ç‹€æ…‹ç®¡ç†
- **Angular Signals**: ç´°ç²’åº¦éŸ¿æ‡‰å¼ç‹€æ…‹
  - \`signal()\`: å¯å¯«ä¿¡è™Ÿ
  - \`computed()\`: è¡ç”Ÿç‹€æ…‹
  - \`effect()\`: å‰¯ä½œç”¨è™•ç†
- **Facade Pattern**: çµ±ä¸€ç‹€æ…‹ç®¡ç† API
- **BlueprintEventBus**: è·¨æ¨¡çµ„äº‹ä»¶é€šè¨Š

### UI æ¨¡å¼
- **Standalone Components**: ç„¡ NgModule
- **OnPush Change Detection**: æ•ˆèƒ½å„ªåŒ–
- **æ–°æ§åˆ¶æµ**: \`@if\`, \`@for\`, \`@switch\`
- **Signals + OnPush**: ç´°ç²’åº¦è®Šæ›´æª¢æ¸¬

---

## è³‡æ–™æ¨¡å‹

### Contract Model (åˆç´„å¯¦é«”)

\`\`\`typescript
export interface Contract {
  // è­˜åˆ¥è³‡è¨Š
  id: string;                          // åˆç´„ ID
  blueprintId: string;                 // æ‰€å±¬ Blueprint ID
  
  // åŸºæœ¬è³‡è¨Š
  title: string;                       // åˆç´„æ¨™é¡Œ
  contractNumber: string;              // åˆç´„ç·¨è™Ÿ
  contractType: ContractType;          // åˆç´„é¡å‹
  description?: string;                // åˆç´„æè¿°
  
  // å¥‘ç´„æ–¹è³‡è¨Š
  partyA: ContractParty;               // ç”²æ–¹ï¼ˆæ¥­ä¸»ï¼‰
  partyB: ContractParty;               // ä¹™æ–¹ï¼ˆæ‰¿åŒ…å•†ï¼‰
  partyC?: ContractParty;              // ä¸™æ–¹ï¼ˆç›£é€ å–®ä½ï¼Œå¯é¸ï¼‰
  
  // é‡‘é¡èˆ‡æ¢æ¬¾
  totalAmount: number;                 // åˆç´„ç¸½é¡
  paidAmount: number;                  // å·²ä»˜é‡‘é¡
  currency: string;                    // å¹£åˆ¥ï¼ˆé è¨­: TWDï¼‰
  paymentTerms?: string;               // ä»˜æ¬¾æ¢ä»¶
  
  // æ™‚ç¨‹è³‡è¨Š
  startDate: Date;                     // é–‹å§‹æ—¥æœŸ
  endDate: Date;                       // çµæŸæ—¥æœŸ
  effectiveDate?: Date;                // ç”Ÿæ•ˆæ—¥æœŸ
  signedDate?: Date;                   // ç°½ç´„æ—¥æœŸ
  
  // ç‹€æ…‹èˆ‡ç‰ˆæœ¬
  status: ContractStatus;              // åˆç´„ç‹€æ…‹
  version: number;                     // ç‰ˆæœ¬è™Ÿ
  previousVersionId?: string;          // å‰ä¸€ç‰ˆæœ¬ ID
  
  // é™„ä»¶èˆ‡æ–‡ä»¶
  attachments: ContractAttachment[];   // é™„ä»¶åˆ—è¡¨
  originalFileUrl?: string;            // åŸå§‹æ–‡ä»¶ URL
  parsedData?: ParsedContractData;     // AI è§£æè³‡æ–™
  
  // å¯©æ ¸è³‡è¨Š
  approvalStatus?: ApprovalStatus;     // å¯©æ‰¹ç‹€æ…‹
  approvalHistory: ApprovalRecord[];   // å¯©æ‰¹æ­·å²
  
  // å…ƒæ•¸æ“š
  createdAt: Date;                     // å»ºç«‹æ™‚é–“
  createdBy: string;                   // å»ºç«‹è€… ID
  updatedAt: Date;                     // æ›´æ–°æ™‚é–“
  updatedBy: string;                   // æ›´æ–°è€… ID
  deletedAt: Date | null;              // åˆªé™¤æ™‚é–“ï¼ˆè»Ÿåˆªé™¤ï¼‰
  
  // é¡å¤–è³‡è¨Š
  tags?: string[];                     // æ¨™ç±¤
  notes?: string;                      // å‚™è¨»
  metadata?: Record<string, any>;      // æ“´å±•æ¬„ä½
}

// åˆç´„é¡å‹
export type ContractType = 
  | 'main_contract'        // ä¸»åˆç´„
  | 'sub_contract'         // åˆ†åŒ…åˆç´„
  | 'supplement'           // è£œå……å”è­°
  | 'change_order'         // è®Šæ›´å–®
  | 'other';               // å…¶ä»–

// åˆç´„ç‹€æ…‹
export type ContractStatus = 
  | 'draft'                // è‰ç¨¿
  | 'under_review'         // å¯©æ ¸ä¸­
  | 'active'               // ç”Ÿæ•ˆä¸­
  | 'completed'            // å·²å®Œæˆ
  | 'terminated'           // å·²çµ‚æ­¢
  | 'suspended';           // æš«åœ

// å¥‘ç´„æ–¹è³‡è¨Š
export interface ContractParty {
  id: string;              // çµ„ç¹”/å€‹äºº ID
  name: string;            // åç¨±
  type: 'organization' | 'individual';  // é¡å‹
  contactPerson?: string;  // è¯çµ¡äºº
  phone?: string;          // é›»è©±
  email?: string;          // Email
  address?: string;        // åœ°å€
}

// é™„ä»¶è³‡è¨Š
export interface ContractAttachment {
  id: string;              // é™„ä»¶ ID
  fileName: string;        // æª”æ¡ˆåç¨±
  fileType: string;        // æª”æ¡ˆé¡å‹ï¼ˆMIMEï¼‰
  fileSize: number;        // æª”æ¡ˆå¤§å°ï¼ˆbytesï¼‰
  storagePath: string;     // Storage è·¯å¾‘
  downloadUrl?: string;    // ä¸‹è¼‰ URLï¼ˆè‡¨æ™‚ï¼‰
  uploadedAt: Date;        // ä¸Šå‚³æ™‚é–“
  uploadedBy: string;      // ä¸Šå‚³è€… ID
}

// AI è§£æè³‡æ–™
export interface ParsedContractData {
  extractedFields: Record<string, any>;  // æå–æ¬„ä½
  workItems: WorkItem[];                 // å·¥é …æ¸…å–®
  keyTerms: string[];                    // é—œéµæ¢æ¬¾
  confidence: number;                    // å¯ä¿¡åº¦ï¼ˆ0-1ï¼‰
  parsedAt: Date;                        // è§£ææ™‚é–“
  parserVersion: string;                 // è§£æå™¨ç‰ˆæœ¬
}

// å·¥é …
export interface WorkItem {
  id: string;              // å·¥é … ID
  name: string;            // å·¥é …åç¨±
  quantity: number;        // æ•¸é‡
  unit: string;            // å–®ä½
  unitPrice: number;       // å–®åƒ¹
  totalPrice: number;      // ç¸½åƒ¹
  description?: string;    // æè¿°
}

// å¯©æ‰¹ç‹€æ…‹
export type ApprovalStatus = 
  | 'pending'              // å¾…å¯©
  | 'approved'             // å·²æ ¸å‡†
  | 'rejected'             // å·²é§å›
  | 'cancelled';           // å·²å–æ¶ˆ

// å¯©æ‰¹è¨˜éŒ„
export interface ApprovalRecord {
  id: string;              // è¨˜éŒ„ ID
  approverUserId: string;  // å¯©æ‰¹è€… ID
  approverName: string;    // å¯©æ‰¹è€…åç¨±
  action: ApprovalStatus;  // å¯©æ‰¹å‹•ä½œ
  comment?: string;        // å¯©æ‰¹æ„è¦‹
  timestamp: Date;         // å¯©æ‰¹æ™‚é–“
  level: number;           // å¯©æ‰¹å±¤ç´š
}
\`\`\`

### Firestore Collection çµæ§‹

\`\`\`
/contracts/{contractId}
  - åˆç´„ä¸»æ–‡ä»¶

/contracts/{contractId}/versions/{versionId}
  - ç‰ˆæœ¬æ­·å²è¨˜éŒ„

/contracts/{contractId}/approvals/{approvalId}
  - å¯©æ‰¹è¨˜éŒ„ï¼ˆå¯é¸ï¼Œä¹Ÿå¯åˆä½µåœ¨ä¸»æ–‡ä»¶ï¼‰

/blueprintMembers/{userId_blueprintId}
  - æˆå“¡è³‡æ ¼ï¼ˆç”¨æ–¼æ¬Šé™æª¢æŸ¥ï¼‰
\`\`\`

### Firestore ç´¢å¼•éœ€æ±‚

\`\`\`javascript
// è¤‡åˆç´¢å¼•
contracts:
  - blueprintId (ASC), status (ASC), createdAt (DESC)
  - blueprintId (ASC), contractType (ASC), createdAt (DESC)
  - blueprintId (ASC), deletedAt (ASC), createdAt (DESC)
  - blueprintId (ASC), endDate (ASC)
\`\`\`

---

## å®‰å…¨èˆ‡æ¬Šé™

### Security Rules è¨­è¨ˆ

#### åŸºæœ¬åŸå‰‡
1. **Blueprint ç‚ºæ¬Šé™é‚Šç•Œ**: æ‰€æœ‰åˆç´„å¿…é ˆå±¬æ–¼ç‰¹å®š Blueprint
2. **æˆå“¡è³‡æ ¼é©—è­‰**: æª¢æŸ¥ \`blueprintMembers\` é›†åˆ
3. **æ¬Šé™å±¤ç´šæ§åˆ¶**: ä¾è§’è‰²å€åˆ†æ“ä½œæ¬Šé™
4. **è³‡æ–™å®Œæ•´æ€§é©—è­‰**: æ¬„ä½é¡å‹ã€å¿…å¡«æ¬„ä½æª¢æŸ¥

### æ¬Šé™çŸ©é™£

| æ“ä½œ | Owner | Admin | Member | Viewer |
|-----|-------|-------|--------|--------|
| è®€å–åˆç´„ | âœ… | âœ… | âœ… | âœ… |
| å»ºç«‹åˆç´„ | âœ… | âœ… | âœ… | âŒ |
| ç·¨è¼¯è‡ªå·±çš„åˆç´„ | âœ… | âœ… | âœ… | âŒ |
| ç·¨è¼¯ä»–äººçš„åˆç´„ | âœ… | âœ… | âŒ | âŒ |
| åˆªé™¤åˆç´„ | âœ… | âœ… | âŒ | âŒ |
| å¯©æ ¸åˆç´„ | âœ… | âœ… | âŒ | âŒ |
| ä¸Šå‚³é™„ä»¶ | âœ… | âœ… | âœ… | âŒ |
| åˆªé™¤é™„ä»¶ | âœ… | âœ… | åƒ…è‡ªå·±ä¸Šå‚³ | âŒ |
| ç®¡ç†æ¬Šé™ | âœ… | âŒ | âŒ | âŒ |

---

## AI èˆ‡æ–‡ä»¶è§£ææ•´åˆ

### æ•´é«”æµç¨‹

\`\`\`
1. ä½¿ç”¨è€…ä¸Šå‚³ PDF
   â†“
2. å‰ç«¯é©—è­‰ï¼ˆæª”æ¡ˆé¡å‹ã€å¤§å°ï¼‰
   â†“
3. ä¸Šå‚³è‡³ Cloud Storage
   â†“
4. è§¸ç™¼ Cloud Function
   â†“
5. å‘¼å« Document AI é€²è¡Œ OCR
   â†“
6. è§£æåˆç´„æ¬„ä½èˆ‡å·¥é …
   â†“
7. å¯«å…¥ Firestore (parsedData)
   â†“
8. ç™¼å¸ƒ contract.parsed äº‹ä»¶
   â†“
9. UI æ›´æ–°ä¸¦é¡¯ç¤ºè§£æçµæœ
\`\`\`

### å‰ç«¯ä¸Šå‚³æµç¨‹

#### æ­¥é©Ÿèªªæ˜
1. **æª”æ¡ˆé¸æ“‡**: ä½¿ç”¨è€…é¸æ“‡ PDF æª”æ¡ˆ
2. **å‰ç«¯é©—è­‰**: 
   - æª”æ¡ˆé¡å‹ï¼šåƒ…å…è¨± PDF
   - æª”æ¡ˆå¤§å°ï¼šæœ€å¤§ 10MB
   - æ¬Šé™æª¢æŸ¥ï¼šç¢ºèªä½¿ç”¨è€…æœ‰ä¸Šå‚³æ¬Šé™
3. **ä¸Šå‚³è‡³ Storage**:
   - è·¯å¾‘ï¼š\`contracts/{blueprintId}/{contractId}/original.pdf\`
   - å–å¾— Download URL
4. **å»ºç«‹åˆç´„è¨˜éŒ„**:
   - å¯«å…¥ Firestore contracts é›†åˆ
   - è¨­å®š \`originalFileUrl\`
   - è¨­å®šç‹€æ…‹ç‚º \`draft\`
5. **è§¸ç™¼è§£æ**:
   - å‘¼å« Cloud Function æˆ–ç›´æ¥è§¸ç™¼
   - é¡¯ç¤ºè§£æä¸­ç‹€æ…‹
6. **ç›£è½è§£æçµæœ**:
   - è¨‚é–± contract æ–‡ä»¶è®Šæ›´
   - è§£æå®Œæˆå¾Œæ›´æ–° UI

### AI è§£ææ¬„ä½å°æ‡‰

| åŸå§‹æ¬„ä½ | ç›®æ¨™æ¬„ä½ | èªªæ˜ |
|---------|---------|------|
| å¥‘ç´„ç·¨è™Ÿ | contractNumber | åˆç´„ç·¨è™Ÿ |
| ç”²æ–¹ | partyA.name | æ¥­ä¸»åç¨± |
| ä¹™æ–¹ | partyB.name | æ‰¿åŒ…å•†åç¨± |
| åˆç´„é‡‘é¡ | totalAmount | ç¸½é‡‘é¡ |
| é–‹å·¥æ—¥æœŸ | startDate | é–‹å§‹æ—¥æœŸ |
| å®Œå·¥æ—¥æœŸ | endDate | çµæŸæ—¥æœŸ |
| å·¥é …æ¸…å–® | parsedData.workItems | å·¥é …åˆ—è¡¨ |

---

## ç‹€æ…‹ç®¡ç†èˆ‡äº‹ä»¶

### Signals-based State Management

#### ContractFacade (ä¸»è¦ç‹€æ…‹ç®¡ç†)

åˆç´„æ¨¡çµ„ä½¿ç”¨ Facade Pattern çµ±ä¸€ç®¡ç†ç‹€æ…‹ï¼Œé€é Angular Signals æä¾›ç´°ç²’åº¦çš„éŸ¿æ‡‰å¼æ›´æ–°ã€‚

**æ ¸å¿ƒ Signals**:
- \`contracts\`: åˆç´„åˆ—è¡¨
- \`selectedContract\`: ç•¶å‰é¸ä¸­çš„åˆç´„
- \`loading\`: è¼‰å…¥ç‹€æ…‹
- \`error\`: éŒ¯èª¤è¨Šæ¯

**Computed Signals**:
- \`contractsByStatus\`: ä¾ç‹€æ…‹åˆ†é¡çš„åˆç´„
- \`totalAmount\`: åˆç´„ç¸½é‡‘é¡
- \`statistics\`: çµ±è¨ˆè³‡è¨Š

### äº‹ä»¶é©…å‹•æ•´åˆ (BlueprintEventBus)

#### åˆç´„äº‹ä»¶é¡å‹

\`\`\`typescript
// åˆç´„äº‹ä»¶é¡å‹
export type ContractEventType =
  | 'contract.created'      // åˆç´„å»ºç«‹
  | 'contract.updated'      // åˆç´„æ›´æ–°
  | 'contract.deleted'      // åˆç´„åˆªé™¤
  | 'contract.uploaded'     // åˆç´„ä¸Šå‚³
  | 'contract.parsed'       // åˆç´„è§£æå®Œæˆ
  | 'contract.approved'     // åˆç´„æ ¸å‡†
  | 'contract.rejected'     // åˆç´„é§å›
  | 'contract.status_changed'; // åˆç´„ç‹€æ…‹è®Šæ›´
\`\`\`

---

## ä½¿ç”¨è€…ä»‹é¢æµç¨‹

### 1. åˆç´„åˆ—è¡¨é  (Contract List)

#### åŠŸèƒ½
- é¡¯ç¤ºåˆç´„åˆ—è¡¨ï¼ˆè¡¨æ ¼æˆ–å¡ç‰‡æ¨¡å¼ï¼‰
- ç‹€æ…‹ç¯©é¸ï¼ˆè‰ç¨¿ã€å¯©æ ¸ä¸­ã€ç”Ÿæ•ˆä¸­ã€å·²å®Œæˆï¼‰
- æœå°‹ï¼ˆåˆç´„ç·¨è™Ÿã€æ¨™é¡Œã€å¥‘ç´„æ–¹ï¼‰
- æ’åºï¼ˆæ—¥æœŸã€é‡‘é¡ã€ç‹€æ…‹ï¼‰
- çµ±è¨ˆè³‡è¨Šï¼ˆç¸½æ•¸ã€é‡‘é¡ã€ç‹€æ…‹åˆ†å¸ƒï¼‰

### 2. åˆç´„å»ºç«‹ç²¾éˆ (Contract Wizard)

#### æµç¨‹æ­¥é©Ÿ
1. **åŸºæœ¬è³‡è¨Š**: æ¨™é¡Œã€ç·¨è™Ÿã€é¡å‹
2. **å¥‘ç´„æ–¹è³‡è¨Š**: ç”²æ–¹ã€ä¹™æ–¹ã€ä¸™æ–¹
3. **é‡‘é¡èˆ‡æ¢æ¬¾**: ç¸½é¡ã€ä»˜æ¬¾æ¢ä»¶
4. **æ™‚ç¨‹è³‡è¨Š**: é–‹å§‹æ—¥æœŸã€çµæŸæ—¥æœŸ
5. **ä¸Šå‚³æ–‡ä»¶**: PDF ä¸Šå‚³èˆ‡ AI è§£æ
6. **ç¢ºèªé€å‡º**: æª¢è¦–æ‘˜è¦ä¸¦å»ºç«‹

### 3. åˆç´„è©³æƒ…é  (Contract Detail)

#### åŠŸèƒ½
- é¡¯ç¤ºå®Œæ•´åˆç´„è³‡è¨Š
- é™„ä»¶åˆ—è¡¨èˆ‡é è¦½
- å¯©æ‰¹æ­·å²
- ç‰ˆæœ¬æ­·å²
- ç›¸é—œä»»å‹™/æ–‡ä»¶

### 4. åˆç´„ç·¨è¼¯é  (Contract Edit)

#### åŠŸèƒ½
- ç·¨è¼¯åˆç´„æ¬„ä½
- ä¿®æ”¹å¥‘ç´„æ–¹è³‡è¨Š
- èª¿æ•´é‡‘é¡èˆ‡æ™‚ç¨‹
- ä¸Šå‚³/åˆªé™¤é™„ä»¶
- å„²å­˜è‰ç¨¿æˆ–é€å‡ºå¯©æ ¸

---

## æ“´å±•æ€§èˆ‡ç¶­è­·

### æœªä¾†æ“´å±•æ–¹å‘

#### 1. é€²éšåŠŸèƒ½
- **é›»å­ç°½ç« **: æ•´åˆé›»å­ç°½ç« æœå‹™
- **è®Šæ›´å–®ç®¡ç†**: åˆç´„è®Šæ›´å–®è¿½è¹¤
- **è£œå……å”è­°**: æ”¯æ´è£œå……å”è­°é—œè¯
- **åˆç´„ç¯„æœ¬**: é è¨­åˆç´„ç¯„æœ¬åº«

#### 2. æ•´åˆåŠŸèƒ½
- **è²¡å‹™æ¨¡çµ„æ•´åˆ**: åˆç´„é‡‘é¡èˆ‡ä»˜æ¬¾è¨˜éŒ„åŒæ­¥
- **ä»»å‹™æ¨¡çµ„æ•´åˆ**: åˆç´„ç›¸é—œä»»å‹™è‡ªå‹•å»ºç«‹
- **å“è³ªæ¨¡çµ„æ•´åˆ**: åˆç´„å±¥ç´„å“è³ªè¿½è¹¤

#### 3. AI å¢å¼·
- **æ™ºèƒ½å¯©æ ¸**: AI è¼”åŠ©åˆç´„å¯©æ ¸
- **é¢¨éšªè©•ä¼°**: è‡ªå‹•è­˜åˆ¥åˆç´„é¢¨éšªé»
- **æ¢æ¬¾æ¯”å°**: èˆ‡æ¨™æº–ç¯„æœ¬æ¯”å°å·®ç•°
- **å±¥ç´„é è­¦**: é æ¸¬å±¥ç´„é¢¨éšª

#### 4. å ±è¡¨èˆ‡åˆ†æ
- **åˆç´„å„€è¡¨æ¿**: è¦–è¦ºåŒ–çµ±è¨ˆåˆ†æ
- **å±¥ç´„ç‡åˆ†æ**: åˆç´„å±¥ç´„æƒ…æ³è¿½è¹¤
- **é‡‘é¡åˆ†æ**: åˆç´„é‡‘é¡è¶¨å‹¢åˆ†æ
- **å¯©æ‰¹æ•ˆç‡**: å¯©æ‰¹æµç¨‹æ•ˆç‡åˆ†æ

### ç¶­è­·æŒ‡å—

#### ç¨‹å¼ç¢¼ç¶­è­·
1. **éµå¾ªä¸‰å±¤æ¶æ§‹**: UI â†’ Service â†’ Repository
2. **ä½¿ç”¨ Signals**: å„ªå…ˆä½¿ç”¨ Signals ç®¡ç†ç‹€æ…‹
3. **äº‹ä»¶é©…å‹•**: è·¨æ¨¡çµ„äº’å‹•ä½¿ç”¨ EventBus
4. **é¡å‹å®‰å…¨**: é¿å…ä½¿ç”¨ \`any\`ï¼Œå®šç¾©å®Œæ•´ä»‹é¢

#### æ¸¬è©¦ç­–ç•¥
1. **å–®å…ƒæ¸¬è©¦**: Repositoryã€Serviceã€Facade
2. **å…ƒä»¶æ¸¬è©¦**: UI å…ƒä»¶äº’å‹•æ¸¬è©¦
3. **æ•´åˆæ¸¬è©¦**: Firestore Emulator æ¸¬è©¦
4. **E2E æ¸¬è©¦**: é—œéµæµç¨‹ç«¯åˆ°ç«¯æ¸¬è©¦

#### æ•ˆèƒ½å„ªåŒ–
1. **OnPush è®Šæ›´æª¢æ¸¬**: æ‰€æœ‰å…ƒä»¶ä½¿ç”¨ OnPush
2. **è™›æ“¬å·å‹•**: å¤§å‹åˆ—è¡¨ä½¿ç”¨ CDK Virtual Scroll
3. **trackBy**: \`@for\` è¿´åœˆä½¿ç”¨ trackBy
4. **åˆ†é è¼‰å…¥**: é¿å…ä¸€æ¬¡è¼‰å…¥æ‰€æœ‰è³‡æ–™

#### æ–‡æª”ç¶­è­·
1. **ä¿æŒæ–‡æª”æ›´æ–°**: åŠŸèƒ½è®Šæ›´æ™‚åŒæ­¥æ›´æ–°æ–‡æª”
2. **API æ–‡æª”**: ä½¿ç”¨ JSDoc è¨»è§£å…¬é–‹ API
3. **è®Šæ›´è¨˜éŒ„**: è¨˜éŒ„é‡è¦è®Šæ›´èˆ‡ç‰ˆæœ¬
4. **ç¯„ä¾‹ç¨‹å¼ç¢¼**: æä¾›ä½¿ç”¨ç¯„ä¾‹

---

## åƒè€ƒè³‡æº

### å°ˆæ¡ˆæ–‡æª”
- [æ¶æ§‹ç¸½è¦½](../../../../docs/architecture(æ¶æ§‹)/01-architecture-overview.md)
- [ä¸‰å±¤æ¶æ§‹](../../../../docs/architecture(æ¶æ§‹)/02-three-layer-architecture.md)
- [åˆç´„ AI æ•´åˆ](../../../../docs/architecture(æ¶æ§‹)/05-contract-ai-integration.md)
- [æ¨¡çµ„ç¯„æœ¬](../README.md)

### Angular æ–‡æª”
- [Angular Signals](https://angular.dev/guide/signals)
- [Standalone Components](https://angular.dev/guide/components/importing)
- [Dependency Injection](https://angular.dev/guide/di)

### Firebase æ–‡æª”
- [Firestore](https://firebase.google.com/docs/firestore)
- [Cloud Storage](https://firebase.google.com/docs/storage)
- [Security Rules](https://firebase.google.com/docs/rules)
- [Cloud Functions](https://firebase.google.com/docs/functions)

### ng-alain æ–‡æª”
- [ST è¡¨æ ¼](https://ng-alain.com/components/st)
- [SF å‹•æ…‹è¡¨å–®](https://ng-alain.com/form)
- [ACL æ¬Šé™](https://ng-alain.com/acl)

---

**ğŸ’¡ è¨­è¨ˆæ€è·¯ç¸½çµ**
- **å°ˆæ³¨åˆç´„æ ¸å¿ƒè³‡æ–™èˆ‡æµç¨‹ç®¡ç†**
- **æ¸…æ¥šç•Œå®šè³‡æ–™ã€é‚è¼¯ã€UI ä¸‰è€…çš„è²¬ä»»**
- **ä½¿ç”¨ \`@angular/fire\` å¯¦ç¾èˆ‡ Firebase çš„é«˜æ•ˆæ•´åˆ**
- **ä¿æŒå¯æ“´å±•æ€§èˆ‡å¯ç¶­è­·æ€§ï¼Œæ”¯æŒæœªä¾†åŠŸèƒ½å»¶ä¼¸ï¼ˆå¦‚ AI è§£æã€çµ±è¨ˆåˆ†æç­‰ï¼‰**

---

**ç¶­è­·è€…**: GigHub é–‹ç™¼åœ˜éšŠ  
**æœ€å¾Œæ›´æ–°**: 2025-12-22  
**ç‰ˆæœ¬**: v1.0.0
