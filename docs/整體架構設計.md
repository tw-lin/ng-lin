根據你的 Angular 專案結構和 NG-ALAIN 框架，這是三個系統的完整架構設計：

## 整體架構設計

```
src/app
│
├── core/                                    # 核心模組（單例服務）
│   ├── auth/                               # 認證相關
│   ├── guards/                             # 路由守衛
│   ├── interceptors/                       # HTTP 攔截器
│   ├── services/                           # 核心服務
│   │   ├── event-bus/                      # 事件總線
│   │   │   ├── event-bus.interface.ts
│   │   │   ├── event-bus.service.ts
│   │   │   ├── domain-event.base.ts
│   │   │   └── event-decorators.ts
│   │   ├── permission/                     # 權限服務
│   │   │   ├── permission.interface.ts
│   │   │   └── permission.service.ts
│   │   ├── tenant/                         # 租戶上下文
│   │   │   ├── tenant-context.interface.ts
│   │   │   └── tenant-context.service.ts
│   │   └── notification/                   # 通知服務（跨領域）
│   │       ├── notification.interface.ts
│   │       └── notification.service.ts
│   ├── models/                             # 核心領域模型
│   │   ├── user.model.ts
│   │   ├── organization.model.ts
│   │   ├── repository.model.ts
│   │   └── permission.model.ts
│   └── core.module.ts
│
├── features/                                # 功能模組（業務領域）
│   │
│   ├── issues/                             # Issue System
│   │   ├── domain/                         # 領域層
│   │   │   ├── models/
│   │   │   │   ├── issue.model.ts
│   │   │   │   ├── issue-comment.model.ts
│   │   │   │   ├── issue-label.model.ts
│   │   │   │   └── issue-milestone.model.ts
│   │   │   ├── events/
│   │   │   │   ├── issue-opened.event.ts
│   │   │   │   ├── issue-closed.event.ts
│   │   │   │   ├── issue-assigned.event.ts
│   │   │   │   ├── issue-labeled.event.ts
│   │   │   │   └── issue-commented.event.ts
│   │   │   └── enums/
│   │   │       ├── issue-state.enum.ts
│   │   │       └── issue-state-reason.enum.ts
│   │   │
│   │   ├── application/                    # 應用層
│   │   │   ├── services/
│   │   │   │   ├── issue.service.ts
│   │   │   │   ├── issue-comment.service.ts
│   │   │   │   ├── issue-label.service.ts
│   │   │   │   └── issue-milestone.service.ts
│   │   │   ├── consumers/                  # 事件消費者
│   │   │   │   ├── issue-notification.consumer.ts
│   │   │   │   ├── issue-activity.consumer.ts
│   │   │   │   └── issue-search.consumer.ts
│   │   │   └── dto/
│   │   │       ├── create-issue.dto.ts
│   │   │       ├── update-issue.dto.ts
│   │   │       ├── issue-filter.dto.ts
│   │   │       └── issue-response.dto.ts
│   │   │
│   │   ├── infrastructure/                 # 基礎設施層
│   │   │   ├── repositories/
│   │   │   │   ├── issue.repository.ts
│   │   │   │   ├── issue.repository.interface.ts
│   │   │   │   └── supabase-issue.repository.ts
│   │   │   └── adapters/
│   │   │       └── issue-firebase.adapter.ts
│   │   │
│   │   ├── presentation/                   # 表現層
│   │   │   ├── pages/
│   │   │   │   ├── issue-list/
│   │   │   │   │   ├── issue-list.component.ts
│   │   │   │   │   ├── issue-list.component.html
│   │   │   │   │   └── issue-list.component.less
│   │   │   │   ├── issue-detail/
│   │   │   │   │   ├── issue-detail.component.ts
│   │   │   │   │   ├── issue-detail.component.html
│   │   │   │   │   └── issue-detail.component.less
│   │   │   │   └── issue-new/
│   │   │   │       ├── issue-new.component.ts
│   │   │   │       ├── issue-new.component.html
│   │   │   │       └── issue-new.component.less
│   │   │   │
│   │   │   ├── components/
│   │   │   │   ├── issue-card/
│   │   │   │   ├── issue-timeline/
│   │   │   │   ├── issue-comment-form/
│   │   │   │   ├── issue-label-selector/
│   │   │   │   ├── issue-assignee-selector/
│   │   │   │   └── issue-milestone-selector/
│   │   │   │
│   │   │   └── store/                      # 狀態管理（如果使用）
│   │   │       ├── issue.state.ts
│   │   │       ├── issue.actions.ts
│   │   │       └── issue.effects.ts
│   │   │
│   │   ├── issues-routing.module.ts
│   │   └── issues.module.ts
│   │
│   ├── discussions/                        # Discussion System
│   │   ├── domain/
│   │   │   ├── models/
│   │   │   │   ├── discussion.model.ts
│   │   │   │   ├── discussion-category.model.ts
│   │   │   │   ├── discussion-comment.model.ts
│   │   │   │   └── discussion-poll.model.ts
│   │   │   ├── events/
│   │   │   │   ├── discussion-created.event.ts
│   │   │   │   ├── discussion-answered.event.ts
│   │   │   │   ├── discussion-upvoted.event.ts
│   │   │   │   └── discussion-commented.event.ts
│   │   │   └── enums/
│   │   │       ├── discussion-state.enum.ts
│   │   │       └── discussion-type.enum.ts
│   │   │
│   │   ├── application/
│   │   │   ├── services/
│   │   │   │   ├── discussion.service.ts
│   │   │   │   ├── discussion-category.service.ts
│   │   │   │   ├── discussion-comment.service.ts
│   │   │   │   └── discussion-vote.service.ts
│   │   │   ├── consumers/
│   │   │   │   ├── discussion-notification.consumer.ts
│   │   │   │   ├── discussion-activity.consumer.ts
│   │   │   │   └── discussion-search.consumer.ts
│   │   │   └── dto/
│   │   │       ├── create-discussion.dto.ts
│   │   │       ├── update-discussion.dto.ts
│   │   │       └── discussion-filter.dto.ts
│   │   │
│   │   ├── infrastructure/
│   │   │   ├── repositories/
│   │   │   │   ├── discussion.repository.ts
│   │   │   │   ├── discussion.repository.interface.ts
│   │   │   │   └── supabase-discussion.repository.ts
│   │   │   └── adapters/
│   │   │       └── discussion-firebase.adapter.ts
│   │   │
│   │   ├── presentation/
│   │   │   ├── pages/
│   │   │   │   ├── discussion-list/
│   │   │   │   ├── discussion-detail/
│   │   │   │   └── discussion-new/
│   │   │   │
│   │   │   └── components/
│   │   │       ├── discussion-card/
│   │   │       ├── discussion-thread/
│   │   │       ├── discussion-comment-tree/
│   │   │       ├── discussion-vote/
│   │   │       ├── discussion-answer-badge/
│   │   │       └── discussion-category-selector/
│   │   │
│   │   ├── discussions-routing.module.ts
│   │   └── discussions.module.ts
│   │
│   └── wiki/                               # Wiki System
│       ├── domain/
│       │   ├── models/
│       │   │   ├── wiki-page.model.ts
│       │   │   ├── wiki-revision.model.ts
│       │   │   ├── wiki-sidebar.model.ts
│       │   │   └── wiki-footer.model.ts
│       │   ├── events/
│       │   │   ├── wiki-page-created.event.ts
│       │   │   ├── wiki-page-updated.event.ts
│       │   │   ├── wiki-page-deleted.event.ts
│       │   │   └── wiki-page-renamed.event.ts
│       │   └── enums/
│       │       └── wiki-page-status.enum.ts
│       │
│       ├── application/
│       │   ├── services/
│       │   │   ├── wiki-page.service.ts
│       │   │   ├── wiki-revision.service.ts
│       │   │   ├── wiki-search.service.ts
│       │   │   └── wiki-navigation.service.ts
│       │   ├── consumers/
│       │   │   ├── wiki-notification.consumer.ts
│       │   │   ├── wiki-activity.consumer.ts
│       │   │   └── wiki-search-indexer.consumer.ts
│       │   └── dto/
│       │       ├── create-wiki-page.dto.ts
│       │       ├── update-wiki-page.dto.ts
│       │       └── wiki-page-filter.dto.ts
│       │
│       ├── infrastructure/
│       │   ├── repositories/
│       │   │   ├── wiki-page.repository.ts
│       │   │   ├── wiki-page.repository.interface.ts
│       │   │   └── supabase-wiki-page.repository.ts
│       │   ├── adapters/
│       │   │   └── wiki-firebase.adapter.ts
│       │   └── parsers/
│       │       ├── markdown-parser.service.ts
│       │       └── wiki-link-parser.service.ts
│       │
│       ├── presentation/
│       │   ├── pages/
│       │   │   ├── wiki-home/
│       │   │   ├── wiki-page-view/
│       │   │   ├── wiki-page-edit/
│       │   │   ├── wiki-page-history/
│       │   │   └── wiki-page-compare/
│       │   │
│       │   └── components/
│       │       ├── wiki-editor/              # Markdown 編輯器
│       │       ├── wiki-preview/
│       │       ├── wiki-toc/                 # 目錄
│       │       ├── wiki-breadcrumb/
│       │       ├── wiki-sidebar/
│       │       ├── wiki-revision-list/
│       │       └── wiki-diff-viewer/
│       │
│       ├── wiki-routing.module.ts
│       └── wiki.module.ts
│
├── shared/                                  # 共享模組
│   ├── components/                          # 通用元件
│   │   ├── markdown-editor/                 # 所有系統共用的 Markdown 編輯器
│   │   ├── user-avatar/
│   │   ├── user-mention/
│   │   ├── emoji-picker/
│   │   ├── file-uploader/
│   │   ├── code-highlighter/
│   │   └── timeline/
│   │
│   ├── directives/                          # 通用指令
│   │   ├── permission.directive.ts
│   │   ├── tenant-scope.directive.ts
│   │   └── auto-resize.directive.ts
│   │
│   ├── pipes/                               # 通用管道
│   │   ├── time-ago.pipe.ts
│   │   ├── markdown.pipe.ts
│   │   ├── highlight.pipe.ts
│   │   └── sanitize-html.pipe.ts
│   │
│   ├── utils/                               # 工具函數
│   │   ├── markdown.utils.ts
│   │   ├── date.utils.ts
│   │   ├── url.utils.ts
│   │   └── validation.utils.ts
│   │
│   ├── constants/                           # 常數定義
│   │   ├── api.constants.ts
│   │   ├── permission.constants.ts
│   │   └── event-types.constants.ts
│   │
│   └── shared.module.ts
│
├── firebase/                                # Firebase 配置
│   ├── firebase.config.ts
│   └── firebase.module.ts
│
└── layout/                                  # 佈局相關
    ├── default/
    ├── header/
    ├── sidebar/
    └── layout.module.ts
```

## 層級架構說明

### Domain Layer (領域層)
```
職責：
- 定義領域模型（實體、值對象）
- 定義領域事件
- 定義領域枚舉
- 包含核心業務規則

原則：
- 不依賴任何外部框架
- 只包含純粹的業務邏輯
- 領域事件是不可變的
```

### Application Layer (應用層)
```
職責：
- 編排業務流程
- 發布和消費領域事件
- 定義 DTO（數據傳輸對象）
- 權限檢查
- 事務管理

原則：
- 依賴領域層
- 不依賴表現層
- 通過介面依賴基礎設施層
```

### Infrastructure Layer (基礎設施層)
```
職責：
- 資料持久化（Repository 實作）
- 外部服務適配器
- 第三方整合

原則：
- 實作 Application 層定義的介面
- 可替換的實作（Supabase/Firebase）
```

### Presentation Layer (表現層)
```
職責：
- UI 元件
- 頁面路由
- 用戶交互
- 狀態管理

原則：
- 只依賴 Application 層的服務
- 不直接依賴 Infrastructure 層
```

## 關鍵設計模式

### 1. Repository Pattern（儲存庫模式）

```typescript
// 介面定義在 Application 層
export interface IIssueRepository {
  findById(id: string): Promise<Issue | null>;
  findAll(filter: IssueFilter): Promise<Issue[]>;
  save(issue: Issue): Promise<Issue>;
  delete(id: string): Promise<void>;
}

// 實作在 Infrastructure 層
export class SupabaseIssueRepository implements IIssueRepository {
  // 具體實作
}
```

### 2. Event-Driven Pattern（事件驅動模式）

```typescript
// 服務發布事件
@Injectable()
export class IssueService {
  async createIssue(dto: CreateIssueDto): Promise<Issue> {
    const issue = await this.repository.save(dto);
    
    await this.eventBus.publish(
      new IssueOpenedEvent({ issue, repository, sender })
    );
    
    return issue;
  }
}

// 消費者訂閱事件
@Injectable()
export class IssueNotificationConsumer extends EventConsumer {
  @Subscribe('issues.opened')
  async handleIssueOpened(event: IssueOpenedEvent) {
    // 發送通知
  }
}
```

### 3. Dependency Injection（依賴注入）

```typescript
// 模組配置
@NgModule({
  providers: [
    IssueService,
    {
      provide: 'IIssueRepository',
      useClass: SupabaseIssueRepository
    }
  ]
})
export class IssuesModule {}

// 服務注入
@Injectable()
export class IssueService {
  constructor(
    @Inject('IIssueRepository') private repository: IIssueRepository
  ) {}
}
```

## 模組依賴關係

```
┌─────────────────────────────────────┐
│     Presentation Layer              │
│   (Components, Pages, Routes)       │
└─────────────────────────────────────┘
              ↓ 依賴
┌─────────────────────────────────────┐
│     Application Layer               │
│  (Services, DTOs, Consumers)        │
└─────────────────────────────────────┘
       ↓ 依賴          ↓ 介面依賴
┌──────────────┐  ┌──────────────────┐
│ Domain Layer │  │Infrastructure     │
│ (Models,     │  │(Repositories,     │
│  Events)     │  │ Adapters)         │
└──────────────┘  └──────────────────┘
```

## 路由結構

```typescript
// issues-routing.module.ts
const routes: Routes = [
  {
    path: ':owner/:repo/issues',
    children: [
      { path: '', component: IssueListComponent },
      { path: 'new', component: IssueNewComponent },
      { path: ':number', component: IssueDetailComponent }
    ]
  }
];

// discussions-routing.module.ts
const routes: Routes = [
  {
    path: ':owner/:repo/discussions',
    children: [
      { path: '', component: DiscussionListComponent },
      { path: 'new', component: DiscussionNewComponent },
      { path: ':number', component: DiscussionDetailComponent }
    ]
  }
];

// wiki-routing.module.ts
const routes: Routes = [
  {
    path: ':owner/:repo/wiki',
    children: [
      { path: '', component: WikiHomeComponent },
      { path: '_new', component: WikiPageEditComponent },
      { path: ':page', component: WikiPageViewComponent },
      { path: ':page/_edit', component: WikiPageEditComponent },
      { path: ':page/_history', component: WikiPageHistoryComponent }
    ]
  }
];
```

## 命名規範

```
檔案命名:
- 模型: issue.model.ts
- 事件: issue-opened.event.ts
- 服務: issue.service.ts
- Repository: issue.repository.ts
- DTO: create-issue.dto.ts
- 元件: issue-list.component.ts
- 消費者: issue-notification.consumer.ts

類別命名:
- 模型: Issue, IssueComment
- 事件: IssueOpenedEvent
- 服務: IssueService
- Repository: IssueRepository
- DTO: CreateIssueDto
- 元件: IssueListComponent
- 消費者: IssueNotificationConsumer
```

這個架構設計遵循：
- 清晰的層級分離
- 依賴倒置原則
- 單一職責原則
- 可測試性
- 可擴展性
- Angular 最佳實踐